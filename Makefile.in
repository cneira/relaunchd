SOURCES = $(shell ls src/*.cc)
TEST_SOURCES = $(shell ls test/*.cc)
JSON_FLAGS ?= $(shell pkg-config --cflags nlohmann_json)
LTO_FLAGS = -flto

all: launchd launchctl

launchd: $(OBJDIR)/Makefile src/launchd.cc $(SOURCES)
	$(CXX) -std=gnu++17 -D_GNU_SOURCE \
    -I $(OBJDIR) \
    $(BUILD_TYPE_FLAGS) \
    $(LTO_FLAGS) \
    $(JSON_FLAGS) \
    -o $(OBJDIR)/launchd \
    $(CXXFLAGS) \
    $(SOURCES)

launchctl:
	ln -s launchd launchctl

test-all:
	# COPYPASTE from above
	$(CXX) -std=gnu++17 -D_GNU_SOURCE \
    -I $(OBJDIR) -I $(OBJDIR)/src "-DTESTDIR=\"$(OBJDIR)/test\"" "-DTMPDIR=\"$(OBJDIR)/tmp\"" \
    $(BUILD_TYPE_FLAGS) \
    $(LTO_FLAGS) \
    $(JSON_FLAGS) \
    -o $(OBJDIR)/test-all \
    $(CXXFLAGS) \
    $(TEST_SOURCES) $(SOURCES)

install: launchd
	install -m 755 launchd $$DESTDIR$(PREFIX)/sbin
	ln -s $(PREFIX)/sbin/launchd $$DESTDIR$(PREFIX)/bin/launchctl
	install -d -m 755 $$DESTDIR/var/db/relaunchd
	install -d -m 755 $$DESTDIR/$(MANDIR)
	install -d -m 755 $$DESTDIR/$(MANDIR)/man8
	install -m 644 launchd.8 $$DESTDIR$(MANDIR)/man8/launchd.8
	install -d -m 755 $$DESTDIR/$(MANDIR)/man1
	install -m 644 man/launchctl.1 $$DESTDIR$(MANDIR)/man1/launchctl.1
	install -d -m 755 $$DESTDIR/$(MANDIR)/man5
	install -m 644 man/launchd.plist.5 $$DESTDIR$(MANDIR)/man5/launchd.plist.5

check: test-all
	./test-all

coverage-report: test-all
	./test-all
	lcov --capture --directory . --output-file coverage.info --exclude /Library/\* --exclude /opt/homebrew/\* --exclude $(OBJDIR)/test/\*
	genhtml coverage.info --output-directory coverage

clean:
	rm -f launchd test-all config.h *.gcda *.gcno
	rm -rf *.dSYM tmp coverage

format:
	clang-format -i src/*.cc src/*.h src/*.hpp
	# TODO: test/*.cc test/*.h test/*.hpp

.PHONY : all check format
